{% extends "layout.html" %}

{% block title %}Mark Attendance - Face Recognition Attendance System{% endblock %}

{% block content %}
<h2 class="page-title">Mark Attendance</h2>

<div class="row">
    <div class="col-lg-8">
        <div class="card animated-card border-0 mb-4">
            <div class="card-header bg-dark text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0"><i class="fas fa-clipboard-check me-2"></i>Attendance Sheet</h3>
                    <div class="badge bg-primary rounded-pill fs-6">
                        <i class="far fa-calendar-alt me-1"></i>
                        {{ selected_date.strftime('%d %b, %Y') }}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h4 class="text-primary mb-0">
                            <i class="fas fa-users me-2"></i>Total Students: <span class="badge bg-primary rounded-pill">{{ students|length }}</span>
                        </h4>
                    </div>
                    <div>
                        <form id="dateSelectForm" class="d-flex align-items-center">
                            <label for="date-select" class="me-2 fw-bold">Change Date:</label>
                            <input type="date" id="date-select" name="date" class="form-control shadow-sm"
                                   value="{{ selected_date.strftime('%Y-%m-%d') }}">
                            <button type="submit" class="btn btn-primary ms-2">
                                <i class="fas fa-calendar-day me-1"></i> Go
                            </button>
                        </form>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="alert alert-info border-0 shadow-sm">
                            <div class="d-flex align-items-center">
                                <div class="p-3 rounded-circle bg-primary bg-opacity-25 me-3">
                                    <i class="fas fa-camera fs-3 text-primary"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1 fw-bold">Face Recognition Mode</h5>
                                    <p class="mb-0">Upload an image or enable the camera to automatically mark attendance when faces are recognized.</p>
                                </div>
                                <div class="ms-auto">
                                    <div class="btn-group btn-group-lg" role="group">
                                        <button type="button" id="upload-image-btn" class="btn btn-primary rounded-start">
                                            <i class="fas fa-upload me-2"></i> Upload Image
                                        </button>
                                        <button id="start-camera-btn" class="btn btn-primary rounded-end">
                                            <i class="fas fa-camera me-2"></i> Start Camera
                                        </button>
                                        <button id="stop-camera-btn" class="btn btn-danger d-none rounded-end">
                                            <i class="fas fa-stop-circle me-2"></i> Stop Camera
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Image Preview Section -->
                <div id="image-preview-section" class="row mb-4 d-none">
                    <div class="col-md-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-dark text-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-image me-2"></i>Image Preview
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="image-preview-container mb-3">
                                            <img id="uploaded-image-preview" class="img-fluid rounded" style="max-height: 400px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex flex-column h-100 justify-content-center">
                                            <button id="process-image-btn" class="btn btn-primary btn-lg mb-3">
                                                <i class="fas fa-cogs me-2"></i> Process Image
                                            </button>
                                            <button id="cancel-upload-btn" class="btn btn-secondary btn-lg">
                                                <i class="fas fa-times me-2"></i> Cancel
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Timeout Settings -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-dark text-white">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-clock me-2"></i>Attendance Time Window
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="start-time" class="form-label">Start Time</label>
                                            <input type="time" id="start-time" class="form-control" value="09:00">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="end-time" class="form-label">End Time</label>
                                            <input type="time" id="end-time" class="form-control" value="17:00">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="late-threshold" class="form-label">Late Threshold (minutes)</label>
                                            <input type="number" id="late-threshold" class="form-control" value="15" min="1">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="timeout-duration" class="form-label">Auto Stop After (minutes)</label>
                                            <input type="number" id="timeout-duration" class="form-control" value="30" min="1">
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-warning mb-0">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <span id="time-window-status">Time window: 09:00 - 17:00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="camera-container" class="row mb-4 d-none">
                    <div class="col-md-12">
                        <div class="camera-selection mb-3">
                            <select id="camera-select" class="form-select">
                                <option value="">Select Camera</option>
                            </select>
                        </div>
                        <div class="camera-container mb-3">
                            <video id="webcam" class="camera-feed" autoplay playsinline></video>
                        </div>
                        <div class="text-center mt-3">
                            <div class="d-inline-flex align-items-center py-2 px-4 rounded-pill bg-dark bg-opacity-10">
                                <div class="spinner-grow spinner-grow-sm text-primary me-2" role="status" id="detection-spinner">
                                    <span class="visually-hidden">Detecting...</span>
                                </div>
                                <p id="recognition-status" class="mb-0 fw-bold">Waiting for face detection...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="manual-attendance">
                    <form id="attendance-form" action="{{ url_for('mark_attendance') }}" method="POST">
                        <input type="hidden" name="date" value="{{ selected_date.strftime('%Y-%m-%d') }}">

                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th><i class="fas fa-id-card me-2"></i>Student ID</th>
                                        <th><i class="fas fa-user me-2"></i>Name</th>
                                        <th><i class="fas fa-clipboard-check me-2"></i>Status</th>
                                        <th><i class="fas fa-clock me-2"></i>Last Updated</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for student in students %}
                                        <tr>
                                            <td class="fw-bold">{{ student.student_id }}</td>
                                            <td>{{ student.name }}</td>
                                            <td>
                                                <input type="hidden" name="student_id" value="{{ student.id }}">
                                                {% if attendances.get(student.id) and attendances[student.id].time_in %}
                                                    <input type="hidden" name="time_in-{{ student.id }}" value="{{ attendances[student.id].time_in }}">
                                                {% endif %}
                                                <select name="status" class="form-select shadow-sm" id="status-{{ student.id }}">
                                                    <option value="Present" {{ 'selected' if attendances.get(student.id) and attendances[student.id].status == 'Present' }}>Present</option>
                                                    <option value="Late" {{ 'selected' if attendances.get(student.id) and attendances[student.id].status == 'Late' }}>Late</option>
                                                    <option value="Absent" {{ 'selected' if (attendances.get(student.id) and attendances[student.id].status == 'Absent') or not attendances.get(student.id) }}>Absent</option>
                                                </select>
                                            </td>
                                            <td id="updated-{{ student.id }}" class="fw-bold">
                                                {% if attendances.get(student.id) and attendances[student.id].time_in %}
                                                    <div class="badge bg-success rounded-pill">
                                                        <i class="fas fa-clock me-1"></i>
                                                        {{ attendances[student.id].time_in.strftime('%I:%M:%S %p') }}
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">Not marked</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-arrow-left me-2"></i> Back
                            </a>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-save me-2"></i> Save Attendance
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card animated-card border-0 mb-4">
            <div class="card-header bg-dark text-white">
                <h3 class="card-title mb-0"><i class="fas fa-chart-pie me-2"></i>Today's Summary</h3>
            </div>
            <div class="card-body">
                <div class="row text-center g-2 mb-3">
                    <div class="col-4">
                        <div class="card card-hover bg-success bg-opacity-10 border-0 p-3">
                            <div class="fs-1 text-success mb-1 fw-bold" id="present-count">{{ attendances.values()|selectattr('status', 'equalto', 'Present')|list|length }}</div>
                            <div class="small text-success fw-bold text-uppercase">Present</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card card-hover bg-warning bg-opacity-10 border-0 p-3">
                            <div class="fs-1 text-warning mb-1 fw-bold" id="late-count">{{ attendances.values()|selectattr('status', 'equalto', 'Late')|list|length }}</div>
                            <div class="small text-warning fw-bold text-uppercase">Late</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="card card-hover bg-danger bg-opacity-10 border-0 p-3">
                            <div class="fs-1 text-danger mb-1 fw-bold" id="absent-count">{{ students|length - attendances.values()|selectattr('status', 'equalto', 'Present')|list|length - attendances.values()|selectattr('status', 'equalto', 'Late')|list|length }}</div>
                            <div class="small text-danger fw-bold text-uppercase">Absent</div>
                        </div>
                    </div>
                </div>

                <div class="progress mb-3" style="height: 10px;">
                    <div class="progress-bar bg-success" role="progressbar" id="present-bar"
                         style="width: {{ (attendances.values()|selectattr('status', 'equalto', 'Present')|list|length / students|length * 100)|round|int if students else 0 }}%"
                         aria-valuenow="{{ attendances.values()|selectattr('status', 'equalto', 'Present')|list|length }}"
                         aria-valuemin="0"
                         aria-valuemax="{{ students|length }}">
                    </div>
                    <div class="progress-bar bg-warning" role="progressbar" id="late-bar"
                         style="width: {{ (attendances.values()|selectattr('status', 'equalto', 'Late')|list|length / students|length * 100)|round|int if students else 0 }}%"
                         aria-valuenow="{{ attendances.values()|selectattr('status', 'equalto', 'Late')|list|length }}"
                         aria-valuemin="0"
                         aria-valuemax="{{ students|length }}">
                    </div>
                    <div class="progress-bar bg-danger" role="progressbar" id="absent-bar"
                         style="width: {{ ((students|length - attendances.values()|selectattr('status', 'equalto', 'Present')|list|length - attendances.values()|selectattr('status', 'equalto', 'Late')|list|length) / students|length * 100)|round|int if students else 0 }}%"
                         aria-valuenow="{{ students|length - attendances.values()|selectattr('status', 'equalto', 'Present')|list|length - attendances.values()|selectattr('status', 'equalto', 'Late')|list|length }}"
                         aria-valuemin="0"
                         aria-valuemax="{{ students|length }}">
                    </div>
                </div>

                <hr>

                <div class="attendance-log mt-4">
                    <h5 class="d-flex align-items-center mb-3">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h5>
                    <div id="activity-log" class="list-group overflow-auto shadow-sm rounded" style="max-height: 300px;">
                        {% set valid_attendances = attendances.values()|selectattr('time_in')|list %}
                        {% if valid_attendances %}
                            {% for attendance in valid_attendances|sort(attribute='time_in', reverse=True) %}
                                <div class="list-group-item list-group-item-action border-0">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1 fw-bold">{{ students|selectattr('id', 'equalto', attendance.student_id)|map(attribute='name')|first }}</h6>
                                    <small class="text-muted">{{ attendance.time_in.strftime('%I:%M:%S %p') }}</small>
                                </div>
                                <p class="mb-1">Marked as
                                    <span class="status-badge
                                    {% if attendance.status == 'Present' %}status-present
                                    {% elif attendance.status == 'Late' %}status-late
                                    {% else %}status-absent{% endif %}">
                                    {{ attendance.status }}
                                    </span>
                                </p>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="list-group-item border-0 text-center py-4">
                                <i class="fas fa-clock fs-4 text-muted mb-2"></i>
                                <p class="text-muted mb-0">No attendance records for today.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="card animated-card border-0">
            <div class="card-header bg-dark text-white">
                <h3 class="card-title mb-0"><i class="fas fa-cog me-2"></i>Options</h3>
            </div>
            <div class="card-body">
                <div class="d-grid gap-3">
                    <a href="{{ url_for('attendance_report') }}" class="btn btn-primary btn-lg card-hover">
                        <i class="fas fa-chart-bar me-2"></i> View Reports
                    </a>
                    <a href="{{ url_for('export_attendance') }}" class="btn btn-secondary btn-lg card-hover">
                        <i class="fas fa-file-export me-2"></i> Export Attendance
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Notification -->
<div id="attendance-notification" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11">
</div>
{% endblock %}

{% block scripts %}
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Date selection form
        const dateForm = document.getElementById('dateSelectForm');
        dateForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const date = document.getElementById('date-select').value;
            window.location.href = "{{ url_for('attendance') }}?date=" + date;
        });

        // Camera functionality (placeholder for face recognition)
        const startCameraBtn = document.getElementById('start-camera-btn');
        const stopCameraBtn = document.getElementById('stop-camera-btn');
        const cameraContainer = document.getElementById('camera-container');
        const video = document.getElementById('webcam');
        const recognitionStatus = document.getElementById('recognition-status');
        let stream = null;
        let detectionInterval = null;
        let lastDetectionTime = 0;
        const DETECTION_INTERVAL = 2000; // Increased to 2 seconds to reduce load
        let isProcessing = false; // Flag to prevent overlapping processing

        // Timeout settings
        const startTimeInput = document.getElementById('start-time');
        const endTimeInput = document.getElementById('end-time');
        const lateThresholdInput = document.getElementById('late-threshold');
        const timeoutDurationInput = document.getElementById('timeout-duration');
        const timeWindowStatus = document.getElementById('time-window-status');
        let timeoutTimer = null;
        let autoStopTimer = null;

        // Update time window status
        function updateTimeWindowStatus() {
            timeWindowStatus.textContent = `Time window: ${startTimeInput.value} - ${endTimeInput.value}`;
        }

        // Initialize time window status
        updateTimeWindowStatus();

        // Add event listeners for time inputs
        startTimeInput.addEventListener('change', updateTimeWindowStatus);
        endTimeInput.addEventListener('change', updateTimeWindowStatus);

        // Check if current time is within the time window
        function isWithinTimeWindow() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const [startHour, startMinute] = startTimeInput.value.split(':').map(Number);
            const [endHour, endMinute] = endTimeInput.value.split(':').map(Number);
            
            const windowStart = startHour * 60 + startMinute;
            const windowEnd = endHour * 60 + endMinute;
            
            return currentTime >= windowStart && currentTime <= windowEnd;
        }

        // Check if student is late
        function isLate() {
            const now = new Date();
            const currentTime = now.getHours() * 60 + now.getMinutes();
            
            const [startHour, startMinute] = startTimeInput.value.split(':').map(Number);
            const windowStart = startHour * 60 + startMinute;
            const lateThreshold = parseInt(lateThresholdInput.value);
            
            return currentTime > windowStart + lateThreshold;
        }

        // Start auto-stop timer
        function startAutoStopTimer() {
            if (autoStopTimer) {
                clearTimeout(autoStopTimer);
            }
            
            const timeoutMinutes = parseInt(timeoutDurationInput.value);
            autoStopTimer = setTimeout(() => {
                showError('Session timed out. Please restart the camera.');
                stopCamera();
            }, timeoutMinutes * 60 * 1000);
        }

        // Add form submission handler to ensure timestamps are preserved
        const attendanceForm = document.getElementById('attendance-form');
        if (attendanceForm) {
            attendanceForm.addEventListener('submit', function(e) {
                // Preserve all timestamps before submission
                const rows = document.querySelectorAll('tr');
                rows.forEach(row => {
                    const studentIdInput = row.querySelector('input[name="student_id"]');
                    if (studentIdInput) {
                        const studentId = studentIdInput.value;
                        const statusSelect = row.querySelector('select[name="status"]');
                        const timeDisplay = row.querySelector('.badge.bg-success');
                        
                        // If student is marked as Present/Late and has a timestamp displayed
                        if (statusSelect && ['Present', 'Late'].includes(statusSelect.value) && timeDisplay) {
                            const timeText = timeDisplay.textContent.trim();
                            // Create or update hidden timestamp field
                            let timeField = row.querySelector(`input[name="time_in-${studentId}"]`);
                            if (!timeField) {
                                timeField = document.createElement('input');
                                timeField.type = 'hidden';
                                timeField.name = `time_in-${studentId}`;
                                row.appendChild(timeField);
                            }
                            timeField.value = timeText;
                        }
                    }
                });
            });
        }

        // Camera selection functionality
        const cameraSelect = document.getElementById('camera-select');
        let availableCameras = [];

        // Function to get available cameras
        async function getAvailableCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                
                // Clear existing options
                cameraSelect.innerHTML = '<option value="">Select Camera</option>';
                
                // Add camera options
                videoDevices.forEach((device, index) => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                availableCameras = videoDevices;
                return videoDevices;
            } catch (error) {
                console.error('Error getting cameras:', error);
                showError('Error accessing camera devices');
                return [];
            }
        }

        // Update camera selection when starting camera
        startCameraBtn.addEventListener('click', async function() {
            // Check if within time window before starting camera
            if (!isWithinTimeWindow()) {
                showError('Cannot start camera outside of attendance time window');
                return;
            }

            // Get available cameras
            await getAvailableCameras();
            
            // Show camera selection if multiple cameras are available
            if (availableCameras.length > 1) {
                document.querySelector('.camera-selection').classList.remove('d-none');
            } else {
                document.querySelector('.camera-selection').classList.add('d-none');
            }

            // Start with default camera
            startCamera();
        });

        // Handle camera selection change
        cameraSelect.addEventListener('change', function() {
            if (stream) {
                stopCamera();
                startCamera();
            }
        });

        // Modified startCamera function
        function startCamera() {
            cameraContainer.classList.remove('d-none');
            startCameraBtn.classList.add('d-none');
            stopCameraBtn.classList.remove('d-none');

            const selectedCameraId = cameraSelect.value;
            const constraints = {
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    deviceId: selectedCameraId ? { exact: selectedCameraId } : undefined,
                    facingMode: selectedCameraId ? undefined : "user"
                }
            };

            navigator.mediaDevices.getUserMedia(constraints)
            .then(function(mediaStream) {
                stream = mediaStream;
                video.srcObject = mediaStream;
                video.play().catch(error => {
                    console.error('Error playing video:', error);
                    showError('Error starting camera. Please try again.');
                });

                // Start continuous face detection
                detectionInterval = setInterval(detectFaces, DETECTION_INTERVAL);

                // Start auto-stop timer
                startAutoStopTimer();
            })
            .catch(function(error) {
                console.error('Error accessing webcam:', error);
                showError('Could not access webcam. Please make sure your camera is connected and permissions are granted.');
                stopCamera();
            });
        }

        function showError(message) {
            recognitionStatus.textContent = message;
            recognitionStatus.classList.add('text-danger');
            setTimeout(() => {
                recognitionStatus.classList.remove('text-danger');
            }, 3000);
        }

        stopCameraBtn.addEventListener('click', stopCamera);

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            if (autoStopTimer) {
                clearTimeout(autoStopTimer);
                autoStopTimer = null;
            }
            cameraContainer.classList.add('d-none');
            startCameraBtn.classList.remove('d-none');
            stopCameraBtn.classList.add('d-none');
            recognitionStatus.textContent = "Waiting for face detection...";
            isProcessing = false;
        }

        function detectFaces() {
            if (!stream || isProcessing) return;
            
            // Check if within time window
            if (!isWithinTimeWindow()) {
                showError('Outside of attendance time window');
                stopCamera();
                return;
            }

            const currentTime = Date.now();
            if (currentTime - lastDetectionTime < DETECTION_INTERVAL) return;
            
            isProcessing = true;
            lastDetectionTime = currentTime;

            try {
                // Check if video is ready
                if (video.readyState !== 4) {
                    console.log('Video not ready');
                    isProcessing = false;
                    return;
                }

                // Capture current frame from video
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Convert to base64
                const imageData = canvas.toDataURL('image/jpeg', 0.8); // Reduced quality for faster processing

                // Get the selected date from the hidden input
                const selectedDate = document.querySelector('input[name="date"]').value;

                // Show processing status
                recognitionStatus.textContent = "Processing faces...";

                // Send to backend for face recognition
                fetch(`/api/recognize_faces?date=${selectedDate}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageData
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.recognized_students && data.recognized_students.length > 0) {
                        // Process all recognized students
                        const recognizedNames = [];
                        data.recognized_students.forEach(student => {
                            const studentStatusSelect = document.getElementById(`status-${student.id}`);
                            if (studentStatusSelect && studentStatusSelect.value === 'Absent') {
                                // Set status based on time
                                studentStatusSelect.value = isLate() ? 'Late' : 'Present';
                                updateAttendanceUI(student.id, student.name);
                                recognizedNames.push(student.name);
                            }
                        });

                        // Update recognition status with all recognized names
                        if (recognizedNames.length > 0) {
                            recognitionStatus.textContent = `Faces recognized: ${recognizedNames.join(', ')}`;
                        } else {
                            recognitionStatus.textContent = "No new faces detected";
                        }
                    } else {
                        recognitionStatus.textContent = "No faces recognized";
                    }
                })
                .catch(error => {
                    console.error('Face recognition error:', error);
                    showError("Error processing faces. Please try again.");
                })
                .finally(() => {
                    isProcessing = false;
                });
            } catch (error) {
                console.error('Error in detectFaces:', error);
                showError("Error in face detection. Please try again.");
                isProcessing = false;
            }
        }

        // Add error handling for video element
        video.addEventListener('error', function(e) {
            console.error('Video error:', e);
            showError('Error with video stream. Please try again.');
            stopCamera();
        });

        // Add error handling for video loading
        video.addEventListener('loadedmetadata', function() {
            console.log('Video metadata loaded');
        });

        // Add error handling for video playing
        video.addEventListener('playing', function() {
            console.log('Video started playing');
        });

        function updateAttendanceUI(studentId, studentName) {
            // Get current time
            const now = new Date();
            const hours = now.getHours() % 12 || 12;
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            const ampm = now.getHours() >= 12 ? 'PM' : 'AM';
            const timeStr = `${hours}:${minutes}:${seconds} ${ampm}`;
            
            // Format time for backend (24-hour format)
            const hours24 = now.getHours().toString().padStart(2, '0');
            const timeValue = `${hours24}:${minutes}:${seconds}`;

            // Update timestamp display in the UI
            const timeElement = document.getElementById(`updated-${studentId}`);
            if (timeElement) {
                timeElement.innerHTML = `
                    <div class="badge bg-success rounded-pill">
                        <i class="fas fa-clock me-1"></i> ${timeStr}
                    </div>
                `;
            }

            // Find the form to add our hidden field
            const form = document.getElementById('attendance-form');
            
            // Get or create the timestamp field
            let timeField = form.querySelector(`input[name="time_in-${studentId}"]`);
            if (!timeField) {
                timeField = document.createElement('input');
                timeField.type = 'hidden';
                timeField.name = `time_in-${studentId}`;
                form.appendChild(timeField);
            }
            
            // Always update the time value
            timeField.value = timeValue;

            // Show notification
            showNotification(studentName);

            // Update summary counts
            updateSummaryCounts();

            // Add to activity log
            addActivityLog(studentName, 'Present', timeStr);
        }

        function showNotification(studentName) {
            const notificationContainer = document.getElementById('attendance-notification');

            // Create toast notification
            const toastElement = document.createElement('div');
            toastElement.className = 'toast';
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');

            toastElement.innerHTML = `
                <div class="toast-header bg-success text-white">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong class="me-auto">Attendance Marked</strong>
                    <small>just now</small>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    <strong>${studentName}</strong> has been marked present.
                </div>
            `;

            notificationContainer.appendChild(toastElement);

            // Initialize and show the toast
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
            toast.show();

            // Remove from DOM after hiding
            toastElement.addEventListener('hidden.bs.toast', function() {
                notificationContainer.removeChild(toastElement);
            });
        }

        function updateSummaryCounts() {
            // Count statuses
            const statuses = Array.from(document.querySelectorAll('select[name="status"]')).map(el => el.value);
            const presentCount = statuses.filter(s => s === 'Present').length;
            const lateCount = statuses.filter(s => s === 'Late').length;
            const absentCount = statuses.filter(s => s === 'Absent').length;

            // Update UI
            document.getElementById('present-count').textContent = presentCount;
            document.getElementById('late-count').textContent = lateCount;
            document.getElementById('absent-count').textContent = absentCount;
        }

        function addActivityLog(studentName, status, time) {
            const activityLog = document.getElementById('activity-log');

            // Create new log entry
            const logEntry = document.createElement('div');
            logEntry.className = 'list-group-item list-group-item-action';

            const statusClass = status === 'Present' ? 'text-success' :
                               status === 'Late' ? 'text-warning' : 'text-danger';

            logEntry.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${studentName}</h6>
                    <small>${time}</small>
                </div>
                <p class="mb-1">Marked as <span class="${statusClass}">${status}</span></p>
            `;

            // Add to top of log
            if (activityLog.firstChild) {
                activityLog.insertBefore(logEntry, activityLog.firstChild);
            } else {
                activityLog.appendChild(logEntry);
            }

            // Remove "No attendance records" message if it exists
            const emptyMessage = activityLog.querySelector('.list-group-item:not(.list-group-item-action)');
            if (emptyMessage) {
                activityLog.removeChild(emptyMessage);
            }
        }

        // Image upload handling
        const imageUpload = document.createElement('input');
        imageUpload.type = 'file';
        imageUpload.accept = 'image/*';
        imageUpload.className = 'd-none';
        document.body.appendChild(imageUpload);

        document.getElementById('upload-image-btn').addEventListener('click', function() {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', function(e) {
            if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    const imageData = e.target.result;
                    // Show image preview
                    const previewSection = document.getElementById('image-preview-section');
                    const previewImage = document.getElementById('uploaded-image-preview');
                    previewImage.src = imageData;
                    previewSection.classList.remove('d-none');
                };

                reader.readAsDataURL(file);
            }
        });

        // Process image button handler
        document.getElementById('process-image-btn').addEventListener('click', function() {
            const previewImage = document.getElementById('uploaded-image-preview');
            if (previewImage.src) {
                processImageForFaceRecognition(previewImage.src);
            }
        });

        // Cancel upload button handler
        document.getElementById('cancel-upload-btn').addEventListener('click', function() {
            const previewSection = document.getElementById('image-preview-section');
            const previewImage = document.getElementById('uploaded-image-preview');
            previewImage.src = '';
            previewSection.classList.add('d-none');
            imageUpload.value = ''; // Reset file input
        });

        function processImageForFaceRecognition(imageData) {
            // Show loading state
            const recognitionStatus = document.getElementById('recognition-status');
            const detectionSpinner = document.getElementById('detection-spinner');
            recognitionStatus.textContent = 'Processing image...';
            detectionSpinner.classList.remove('d-none');

            // Disable process button during processing
            const processButton = document.getElementById('process-image-btn');
            processButton.disabled = true;
            processButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';

            // Send image to server for face recognition
            fetch('/api/recognize_faces', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    image: imageData,
                    date: document.querySelector('input[name="date"]').value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                // Update attendance status for recognized students
                data.recognized_students.forEach(student => {
                    const statusSelect = document.getElementById(`status-${student.id}`);
                    if (statusSelect) {
                        statusSelect.value = 'Present';
                        const timeField = document.querySelector(`input[name="time_in-${student.id}"]`);
                        if (timeField) {
                            timeField.value = student.detection_time;
                        }
                        updateStatusBadge(student.id, 'Present', student.detection_time);
                        // Show notification for each recognized student
                        showNotification(student.name);
                    }
                });

                // Update summary counts
                updateSummaryCounts();

                // Show success message
                recognitionStatus.textContent = `Successfully processed image. Recognized ${data.recognized_students.length} students.`;
                
                // Hide preview section after successful processing
                const previewSection = document.getElementById('image-preview-section');
                previewSection.classList.add('d-none');

                // Add to activity log
                data.recognized_students.forEach(student => {
                    addActivityLog(student.name, 'Present', student.detection_time);
                });
            })
            .catch(error => {
                console.error('Error:', error);
                recognitionStatus.textContent = 'Error processing image: ' + error.message;
            })
            .finally(() => {
                detectionSpinner.classList.add('d-none');
                // Re-enable process button
                processButton.disabled = false;
                processButton.innerHTML = '<i class="fas fa-cogs me-2"></i> Process Image';
            });
        }

        function updateStatusBadge(studentId, status, time) {
            const updatedCell = document.getElementById(`updated-${studentId}`);
            if (updatedCell) {
                updatedCell.innerHTML = `
                    <div class="badge bg-success rounded-pill">
                        <i class="fas fa-clock me-1"></i>
                        ${time}
                    </div>
                `;
            }
        }
    });
</script>
{% endblock %}